<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Frontend Schedule Fixes</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
    </style>
</head>
<body>
    <h1>üîß Test Frontend Schedule Fixes</h1>
    <p>Testing the fixes for teacher assignment and display issues</p>
    
    <div>
        <button class="btn-primary" onclick="testTeacherData()">Test Teacher Data Structure</button>
        <button class="btn-success" onclick="testScheduleCreation()">Test Schedule Creation</button>
        <button class="btn-danger" onclick="testScheduleDisplay()">Test Schedule Display</button>
        <button class="btn-primary" onclick="runAllTests()">Run All Tests</button>
    </div>

    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:3002/api';
        const authToken = 'mock-token'; // Since auth is disabled

        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            resultsDiv.appendChild(div);
            console.log(message);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function testTeacherData() {
            clearResults();
            log('üß™ Testing Teacher Data Structure...', 'info');

            try {
                const response = await fetch(`${API_BASE}/users/role/teacher`);
                const data = await response.json();
                
                if (data.success && data.data.length > 0) {
                    log('‚úÖ Teachers fetched successfully', 'success');
                    
                    const teacher = data.data[0];
                    log(`üìã Sample teacher structure:`, 'info');
                    log(`<pre>${JSON.stringify(teacher, null, 2)}</pre>`, 'info');
                    
                    // Check if teacher has firstName and lastName
                    if (teacher.firstName && teacher.lastName) {
                        log(`‚úÖ Teacher has firstName: "${teacher.firstName}" and lastName: "${teacher.lastName}"`, 'success');
                        log(`‚úÖ Full name would be: "${teacher.firstName} ${teacher.lastName}"`, 'success');
                    } else {
                        log('‚ùå Teacher missing firstName or lastName fields', 'error');
                    }
                    
                    // Check if teacher has old 'name' field
                    if (teacher.name) {
                        log('‚ö†Ô∏è Teacher still has old "name" field - this might cause confusion', 'warning');
                    } else {
                        log('‚úÖ Teacher does not have old "name" field', 'success');
                    }
                    
                } else {
                    log('‚ùå No teachers found or API error', 'error');
                }
            } catch (error) {
                log(`‚ùå Error fetching teachers: ${error.message}`, 'error');
            }
        }

        async function testScheduleCreation() {
            log('üß™ Testing Schedule Creation with Teacher Assignment...', 'info');

            try {
                // Get teachers and courses
                const [teachersRes, coursesRes, groupsRes] = await Promise.all([
                    fetch(`${API_BASE}/users/role/teacher`),
                    fetch(`${API_BASE}/courses`),
                    fetch(`${API_BASE}/groups`)
                ]);

                const teachersData = await teachersRes.json();
                const coursesData = await coursesRes.json();
                const groupsData = await groupsRes.json();

                if (!teachersData.success || !coursesData.success || !groupsData.success) {
                    log('‚ùå Failed to fetch required data', 'error');
                    return;
                }

                const teacher = teachersData.data[0];
                const course = coursesData.data[0];
                const group = groupsData.data[0];

                log(`üéØ Using teacher: ${teacher.firstName} ${teacher.lastName} (ID: ${teacher.id})`, 'info');
                log(`üéØ Using course: ${course.name} (ID: ${course.id})`, 'info');
                log(`üéØ Using group: ${group.name} (ID: ${group.id})`, 'info');

                // Simulate frontend data preparation
                const classData = {
                    day: 'friday',
                    startTime: '15:00',
                    endTime: '15:45',
                    subject: course.name,
                    teacher: `${teacher.firstName} ${teacher.lastName}`,
                    notes: 'Test schedule with frontend fixes'
                };

                log('üìù Frontend class data:', 'info');
                log(`<pre>${JSON.stringify(classData, null, 2)}</pre>`, 'info');

                // Calculate duration
                const startTime = new Date(`2000-01-01 ${classData.startTime}`);
                const endTime = new Date(`2000-01-01 ${classData.endTime}`);
                const durationMinutes = (endTime.getTime() - startTime.getTime()) / (1000 * 60);

                // Prepare schedule data (like frontend does after fixes)
                const scheduleData = {
                    day_of_week: classData.day,
                    start_time: classData.startTime,
                    end_time: classData.endTime,
                    duration_minutes: durationMinutes,
                    notes: classData.notes || '',
                    group_id: group.id,
                    course_id: course.id,
                    teacher_id: teacher.id,
                    room_id: null
                };

                log('üìã Final schedule data to be sent (after fixes):', 'info');
                log(`<pre>${JSON.stringify(scheduleData, null, 2)}</pre>`, 'info');

                // Create schedule
                const response = await fetch(`${API_BASE}/schedules`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(scheduleData)
                });

                const result = await response.json();

                if (result.success) {
                    log('üéâ Schedule created successfully!', 'success');
                    log(`üìã Created schedule: ${JSON.stringify(result.data, null, 2)}`, 'success');
                    
                    // Check if teacher_id was saved
                    if (result.data.teacher_id) {
                        log(`‚úÖ Teacher ID saved: ${result.data.teacher_id}`, 'success');
                    } else {
                        log('‚ùå Teacher ID not saved!', 'error');
                    }
                    
                } else {
                    log(`‚ùå Schedule creation failed: ${result.message}`, 'error');
                }

            } catch (error) {
                log(`‚ùå Error during schedule creation test: ${error.message}`, 'error');
            }
        }

        async function testScheduleDisplay() {
            log('üß™ Testing Schedule Display with Relations...', 'info');

            try {
                const groupId = 'b23ce3b0-86ea-4a10-9c3c-4976f4273069'; // Creative Explorers
                const response = await fetch(`${API_BASE}/schedules/group/${groupId}`);
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    log(`‚úÖ Found ${data.data.length} schedules for group`, 'success');
                    
                    // Test how frontend would process this data
                    const processedSchedules = data.data.map((schedule) => ({
                        id: schedule.id,
                        day: schedule.day_of_week,
                        startTime: schedule.start_time.substring(0, 5),
                        endTime: schedule.end_time.substring(0, 5),
                        subject: schedule.course?.name || 'ÿπÿßŸÖ',
                        teacher: schedule.teacher?.firstName ? `${schedule.teacher.firstName} ${schedule.teacher.lastName}` : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ',
                        room: schedule.room?.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ',
                        notes: schedule.notes || '',
                        courseId: schedule.course_id,
                        teacherId: schedule.teacher_id,
                        groupId: schedule.group_id
                    }));

                    log('üìä Processed schedules (as frontend would display):', 'info');
                    
                    let withTeachers = 0;
                    let withoutTeachers = 0;
                    let courseNames = new Set();
                    
                    processedSchedules.forEach((schedule, index) => {
                        if (index < 3) { // Show first 3 as examples
                            log(`<pre>Schedule ${index + 1}:
  Subject: ${schedule.subject}
  Teacher: ${schedule.teacher}
  Room: ${schedule.room}
  Time: ${schedule.startTime} - ${schedule.endTime}</pre>`, 'info');
                        }
                        
                        if (schedule.teacher !== 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ') withTeachers++;
                        else withoutTeachers++;
                        
                        courseNames.add(schedule.subject);
                    });

                    log(`üìà Summary:`, 'info');
                    log(`  ‚Ä¢ Schedules with teachers: ${withTeachers}`, 'info');
                    log(`  ‚Ä¢ Schedules without teachers: ${withoutTeachers}`, 'info');
                    log(`  ‚Ä¢ Unique course names: ${Array.from(courseNames).join(', ')}`, 'info');
                    
                    if (courseNames.size > 1) {
                        log('‚úÖ Multiple course names found - no more duplicate subject issue!', 'success');
                    }
                    
                } else {
                    log('‚ùå No schedules found for group', 'error');
                }

            } catch (error) {
                log(`‚ùå Error during schedule display test: ${error.message}`, 'error');
            }
        }

        async function runAllTests() {
            clearResults();
            log('üöÄ Running All Frontend Fix Tests...', 'info');
            log('=' .repeat(50), 'info');
            
            await testTeacherData();
            log('', 'info');
            await testScheduleCreation();
            log('', 'info');
            await testScheduleDisplay();
            
            log('', 'info');
            log('üéØ All tests completed!', 'success');
        }
    </script>
</body>
</html>
