<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Frontend Teacher Assignment Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
    </style>
</head>
<body>
    <h1>üîß Test Frontend Teacher Assignment Fix</h1>
    <p>Testing that teacher assignments now work correctly in the frontend</p>
    
    <div>
        <button class="btn-primary" onclick="testTeacherLookup()">Test Teacher Lookup Logic</button>
        <button class="btn-success" onclick="testScheduleCreation()">Test Schedule Creation</button>
        <button class="btn-primary" onclick="testDisplayLogic()">Test Display Logic</button>
    </div>

    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:3002/api';

        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            resultsDiv.appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function testTeacherLookup() {
            clearResults();
            log('üß™ Testing Teacher Lookup Logic...', 'info');

            try {
                // Get teachers from API
                const response = await fetch(`${API_BASE}/users/role/teacher`);
                const data = await response.json();

                if (!data.success) {
                    log('‚ùå Failed to fetch teachers', 'error');
                    return;
                }

                // Simulate frontend teacher processing (after fix)
                const teachers = data.data.map(teacher => ({
                    id: teacher.id,
                    firstName: teacher.firstName,
                    lastName: teacher.lastName,
                    name: `${teacher.firstName} ${teacher.lastName}`,
                    email: teacher.email
                }));

                log(`‚úÖ Loaded ${teachers.length} teachers`, 'success');
                log(`<pre>${JSON.stringify(teachers, null, 2)}</pre>`, 'info');

                // Test teacher lookup with different scenarios
                const testCases = [
                    { teacher: 'Aisha Mohamed', expected: 'a845910d-da81-48d2-9dc7-3b3f5ebc3716' },
                    { teacher: 'Sara Abdullah', expected: '46d30267-6432-4727-896c-b5aad126a61f' },
                    { teacher: 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ', expected: null },
                    { teacher: 'Non-existent Teacher', expected: null }
                ];

                log('üîç Testing teacher lookup scenarios:', 'info');

                testCases.forEach(testCase => {
                    const foundTeacher = teachers.find(t => {
                        const fullName = `${t.firstName} ${t.lastName}`;
                        return fullName === testCase.teacher || t.id === testCase.teacher;
                    });

                    const foundId = foundTeacher?.id || null;
                    const isCorrect = foundId === testCase.expected;

                    log(`  ${isCorrect ? '‚úÖ' : '‚ùå'} "${testCase.teacher}" ‚Üí ${foundId || 'null'}`, 
                        isCorrect ? 'success' : 'error');
                });

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testScheduleCreation() {
            log('üß™ Testing Schedule Creation with Teacher Assignment...', 'info');

            try {
                // Get required data
                const [teachersRes, coursesRes, groupsRes] = await Promise.all([
                    fetch(`${API_BASE}/users/role/teacher`),
                    fetch(`${API_BASE}/courses`),
                    fetch(`${API_BASE}/groups`)
                ]);

                const teachersData = await teachersRes.json();
                const coursesData = await coursesRes.json();
                const groupsData = await groupsRes.json();

                if (!teachersData.success || !coursesData.success || !groupsData.success) {
                    log('‚ùå Failed to fetch required data', 'error');
                    return;
                }

                // Simulate frontend data processing
                const teachers = teachersData.data.map(teacher => ({
                    id: teacher.id,
                    firstName: teacher.firstName,
                    lastName: teacher.lastName,
                    name: `${teacher.firstName} ${teacher.lastName}`,
                    email: teacher.email
                }));

                const teacher = teachers[0];
                const course = coursesData.data[0];
                const group = groupsData.data[0];

                // Simulate class data from modal
                const classData = {
                    day: 'wednesday',
                    startTime: '11:00',
                    endTime: '11:45',
                    subject: course.name,
                    teacher: `${teacher.firstName} ${teacher.lastName}`,
                    notes: 'Frontend fix test'
                };

                log('üìù Simulated class data from modal:', 'info');
                log(`<pre>${JSON.stringify(classData, null, 2)}</pre>`, 'info');

                // Simulate frontend teacher lookup (after fix)
                const foundTeacher = teachers.find(t => {
                    const fullName = `${t.firstName} ${t.lastName}`;
                    return fullName === classData.teacher || t.id === classData.teacher;
                });

                log(`üîç Teacher lookup result: ${foundTeacher ? 'Found' : 'Not found'}`, 
                    foundTeacher ? 'success' : 'error');

                if (foundTeacher) {
                    log(`   Teacher: ${foundTeacher.firstName} ${foundTeacher.lastName}`, 'info');
                    log(`   ID: ${foundTeacher.id}`, 'info');
                }

                // Calculate duration
                const startTime = new Date(`2000-01-01 ${classData.startTime}`);
                const endTime = new Date(`2000-01-01 ${classData.endTime}`);
                const durationMinutes = (endTime.getTime() - startTime.getTime()) / (1000 * 60);

                // Find course
                const foundCourse = coursesData.data.find(c => c.name === classData.subject);

                // Prepare schedule data (as frontend would after fix)
                const scheduleData = {
                    day_of_week: classData.day,
                    start_time: classData.startTime,
                    end_time: classData.endTime,
                    duration_minutes: durationMinutes,
                    notes: classData.notes || '',
                    group_id: group.id,
                    course_id: foundCourse?.id || null,
                    teacher_id: foundTeacher?.id || null,
                    room_id: null
                };

                log('üìã Final schedule data to be sent:', 'info');
                log(`<pre>${JSON.stringify(scheduleData, null, 2)}</pre>`, 'info');

                if (scheduleData.teacher_id) {
                    log('‚úÖ Teacher ID will be saved correctly', 'success');
                } else {
                    log('‚ùå Teacher ID is null - will not be saved', 'error');
                }

                // Actually create the schedule
                const createResponse = await fetch(`${API_BASE}/schedules`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(scheduleData)
                });

                const result = await createResponse.json();

                if (result.success) {
                    log('üéâ Schedule created successfully!', 'success');
                    log(`   Schedule ID: ${result.data.id}`, 'info');
                    log(`   Teacher ID saved: ${result.data.teacher_id}`, 'success');
                } else {
                    log(`‚ùå Schedule creation failed: ${result.message}`, 'error');
                }

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testDisplayLogic() {
            log('üß™ Testing Schedule Display Logic...', 'info');

            try {
                const groupId = 'e797a434-64a1-47a6-ba41-6f3666596bc6';
                const response = await fetch(`${API_BASE}/schedules/group/${groupId}`);
                const data = await response.json();

                if (!data.success) {
                    log('‚ùå Failed to fetch schedules', 'error');
                    return;
                }

                log(`‚úÖ Fetched ${data.data.length} schedules`, 'success');

                // Simulate how frontend processes schedule data for display
                const processedSchedules = data.data.map(schedule => ({
                    id: schedule.id,
                    day: schedule.day_of_week,
                    startTime: schedule.start_time.substring(0, 5),
                    endTime: schedule.end_time.substring(0, 5),
                    subject: schedule.course?.name || 'ÿπÿßŸÖ',
                    teacher: schedule.teacher?.firstName ? 
                        `${schedule.teacher.firstName} ${schedule.teacher.lastName}` : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ',
                    room: schedule.room?.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ',
                    teacherId: schedule.teacher_id,
                    courseId: schedule.course_id
                }));

                // Analyze the results
                let withTeachers = 0;
                let withoutTeachers = 0;
                let courseNames = new Set();

                processedSchedules.forEach(schedule => {
                    if (schedule.teacher !== 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ') withTeachers++;
                    else withoutTeachers++;
                    courseNames.add(schedule.subject);
                });

                log('üìä Display Analysis:', 'info');
                log(`   Schedules with teachers: ${withTeachers}`, 'success');
                log(`   Schedules without teachers: ${withoutTeachers}`, 'warning');
                log(`   Unique course names: ${courseNames.size}`, 'info');
                log(`   Course names: ${Array.from(courseNames).join(', ')}`, 'info');

                // Show examples
                log('üìã Sample processed schedules:', 'info');
                processedSchedules.slice(0, 3).forEach((schedule, index) => {
                    log(`<pre>Schedule ${index + 1}:
  Subject: ${schedule.subject}
  Teacher: ${schedule.teacher}
  Room: ${schedule.room}
  Time: ${schedule.startTime} - ${schedule.endTime}
  Teacher ID: ${schedule.teacherId || 'null'}</pre>`, 'info');
                });

                // Check for the fix
                const schedulesWithTeacherIds = processedSchedules.filter(s => s.teacherId);
                if (schedulesWithTeacherIds.length > 0) {
                    log(`‚úÖ Found ${schedulesWithTeacherIds.length} schedules with teacher IDs - fix is working!`, 'success');
                } else {
                    log('‚ö†Ô∏è No schedules with teacher IDs found - may need to create new schedules', 'warning');
                }

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
